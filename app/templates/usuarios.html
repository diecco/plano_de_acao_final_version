{% extends 'layout.html' %}

{% block titulo %}Cadastro de Usuários{% endblock %}

{% block conteudo %}
<h2 class="mb-4 text-center text-laranja">CADASTRO DE USUÁRIOS</h2>
<hr>

{% with messages = get_flashed_messages() %}
  {% if messages %}
    <div class="alert alert-success">{{ messages[0] }}</div>
  {% endif %}
{% endwith %}

<form method="POST" class="mb-5">
  <div class="row">
    <div class="col-md-6 mb-3">
      <label for="nome" class="form-label">Nome</label>
      <input type="text" class="form-control" id="nome" name="nome" required>
    </div>
    <div class="col-md-6 mb-3">
      <label for="email" class="form-label">Email</label>
      <input type="email" class="form-control" id="email" name="email" required>
    </div>
  </div>
  <div class="row">
    <div class="col-md-6 mb-3">
      <label for="centro_custos_id" class="form-label">Centro de Custos</label>
      <select class="form-select" id="centro_custos_id" name="centro_custos_id" required>
        <option value="">Selecione</option>
        {% for c in centros_custos %}
        <option value="{{ c.id }}" data-super-id="{{ c.superintendencia_id }}" data-super-nome="{{ c.superintendencia_nome }}">
          {{ c.codigo }} - {{ c.descricao }}
        </option>
        {% endfor %}
      </select>
    </div>
    <div class="col-md-6 mb-3">
      <label for="superintendencia_nome" class="form-label">Superintendência</label>
      <input type="text" class="form-control" id="superintendencia_nome" readonly>
      <input type="hidden" name="superintendencia_id" id="superintendencia_id">
    </div>
  </div>
  <div class="row">
    <div class="col-md-6 mb-3">
      <label for="senha" class="form-label">Senha Inicial</label>
      <input type="password" class="form-control" id="senha" name="senha" required>
    </div>
    <div class="col-md-6 mb-3">
      <label for="perfil" class="form-label">Perfil</label>
      <select class="form-select" id="perfil" name="perfil" required>
        <option value="">Selecione</option>
        <option value="basico">Básico</option>
        <option value="intermediario">Intermediário</option>
        <option value="avancado">Avançado</option>
        <option value="administrador">Administrador</option>
      </select>
    </div>
  </div>
  <div class="d-flex justify-content-between">
    <button type="submit" class="btn btn-laranja">Salvar</button>
    <a href="/dashboard" class="btn btn-cinza">Voltar</a>
  </div>
</form>

<hr>

<h4 class="mb-4 text-center text-laranja">USUÁRIOS CADASTRADOS</h4>

<style>
  /* Ordenação e filtro (mesmo padrão do dashboard) */
  th.sortable { cursor: pointer; position: relative; user-select: none; white-space: nowrap; }
  th.sortable .th-label { padding-right: 1.75rem; display: inline-block; }
  th.sortable .sort-indicator { position: absolute; right: 8px; top: 50%; transform: translateY(-50%); font-size: .85rem; opacity: .6; }
  .filter-btn { border: 0; background: transparent; margin-left: .35rem; padding: 0 .15rem; line-height: 1; cursor: pointer; opacity: .8; }
  .filter-btn:hover { opacity: 1; }
  .filter-menu { position: absolute; z-index: 1100; background: #fff; border: 1px solid #ddd; border-radius: .5rem; padding: .5rem; min-width: 180px; box-shadow: 0 6px 18px rgba(0,0,0,.12); }
  .filter-menu .form-select { font-size: .9rem; }
</style>

<div class="table-responsive">
  <table class="table table-striped mt-3 sortable-table" id="tabelaUsuarios">
    <thead>
      <tr>
        <th class="sortable" data-type="text"><span class="th-label">Nome</span><span class="sort-indicator">↕</span></th>
        <th class="sortable" data-type="text"><span class="th-label">Email</span><span class="sort-indicator">↕</span></th>
        <th class="sortable with-filter" data-type="text" data-filter-col="perfil">
          <span class="th-label">Perfil</span>
          <button class="filter-btn" title="Filtrar">⏷</button>
          <span class="sort-indicator">↕</span>
        </th>
        <th class="sortable with-filter" data-type="text" data-filter-col="cc">
          <span class="th-label">Centro de Custos</span>
          <button class="filter-btn" title="Filtrar">⏷</button>
          <span class="sort-indicator">↕</span>
        </th>
        <th class="sortable with-filter" data-type="text" data-filter-col="super">
          <span class="th-label">Superintendência</span>
          <button class="filter-btn" title="Filtrar">⏷</button>
          <span class="sort-indicator">↕</span>
        </th>
        <th class="sortable with-filter" data-type="text" data-filter-col="status">
          <span class="th-label">Status</span>
          <button class="filter-btn" title="Filtrar">⏷</button>
          <span class="sort-indicator">↕</span>
        </th>
        <th><span class="th-label">Ações</span></th>
      </tr>
    </thead>
    <tbody>
      {% for u in usuarios %}
      <tr>
        <td data-filter="nome">{{ u.nome }}</td>
        <td data-filter="email">{{ u.email }}</td>
        <td data-filter="perfil">{{ u.perfil }}</td>
        <td data-filter="cc">{{ u.codigo_cc }} - {{ u.descricao_cc }}</td>
        <td data-filter="super">{{ u.nome_superintendencia }}</td>
        <td data-filter="status">{{ 'Ativo' if u.ativo else 'Inativo' }}</td>
        <td>
          <a href="/editar_usuario/{{ u.id }}" class="btn btn-laranja">Editar</a>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<script>
  // Preenche Superintendência automática no formulário
  document.getElementById('centro_custos_id').addEventListener('change', function () {
    const selected = this.options[this.selectedIndex];
    const superNome = selected.getAttribute('data-super-nome');
    const superId = selected.getAttribute('data-super-id');
    document.getElementById('superintendencia_nome').value = superNome || '';
    document.getElementById('superintendencia_id').value = superId || '';
  });

  // ------- Ordenação / Filtro da tabela -------
  function parseCellValue(td, type) {
    return td.textContent.trim().toLowerCase();
  }

  function sortTable(table, colIndex, type, direction) {
    const tbody = table.tBodies[0];
    const rows = Array.from(tbody.querySelectorAll('tr'));
    rows.sort((a, b) => {
      const va = parseCellValue(a.children[colIndex], type);
      const vb = parseCellValue(b.children[colIndex], type);
      if (va < vb) return direction === 'asc' ? -1 : 1;
      if (va > vb) return direction === 'asc' ? 1 : -1;
      return 0;
    });
    rows.forEach(r => tbody.appendChild(r));
  }

  function buildFilterMenu(th, table, colIndex) {
    // Remove qualquer menu aberto
    document.querySelectorAll('.filter-menu').forEach(m => m.remove());

    const menu = document.createElement('div');
    menu.className = 'filter-menu';

    // Coleta de valores únicos
    const vals = new Set();
    table.querySelectorAll('tbody tr').forEach(tr => {
      const td = tr.children[colIndex];
      vals.add(td.textContent.trim());
    });
    const arr = Array.from(vals).filter(v => v.length).sort((a,b)=>a.localeCompare(b,'pt-BR'));

    menu.innerHTML = `
      <div class="mb-2 fw-semibold">Filtrar por ${th.querySelector('.th-label').textContent}</div>
      <select class="form-select mb-2 filter-select">
        <option value="">(todos)</option>
        ${arr.map(v => `<option value="${v.replace(/"/g,'&quot;')}">${v}</option>`).join('')}
      </select>
      <div class="d-flex gap-2">
        <button type="button" class="btn btn-sm btn-laranja aplicar">Aplicar</button>
        <button type="button" class="btn btn-sm btn-secondary limpar">Limpar</button>
      </div>
    `;

    document.body.appendChild(menu);
    const rect = th.getBoundingClientRect();
    menu.style.top  = (window.scrollY + rect.bottom + 6) + 'px';
    menu.style.left = (window.scrollX + rect.left) + 'px';

    const select = menu.querySelector('.filter-select');

    function applyFilter(val) {
      table.querySelectorAll('tbody tr').forEach(tr => {
        const txt = tr.children[colIndex].textContent.trim();
        tr.style.display = (!val || txt === val) ? '' : 'none';
      });
    }

    // Fecha o popover depois de aplicar/limpar
    menu.querySelector('.aplicar').onclick = () => { applyFilter(select.value); menu.remove(); };
    menu.querySelector('.limpar').onclick  = () => { select.value=''; applyFilter(''); menu.remove(); };

    // Fecha ao clicar fora
    document.addEventListener('click', (e) => {
      if (!menu.contains(e.target) && e.target !== th.querySelector('.filter-btn')) {
        menu.remove();
      }
    }, { once: true });
  }

  (function initSortableAndFilters() {
    const table = document.getElementById('tabelaUsuarios');
    table.querySelectorAll('th').forEach((th, idx) => {
      const type = th.getAttribute('data-type') || 'text';

      // Ordenação
      const label = th.querySelector('.th-label');
      if (label && th.classList.contains('sortable')) {
        let dir = 'asc';
        label.addEventListener('click', () => {
          sortTable(table, idx, type, dir);
          dir = (dir === 'asc' ? 'desc' : 'asc');
          const ind = th.querySelector('.sort-indicator');
          if (ind) ind.textContent = dir === 'asc' ? '↑' : '↓';
        });
      }

      // Filtro
      const filterBtn = th.querySelector('.filter-btn');
      if (filterBtn && th.classList.contains('with-filter')) {
        filterBtn.addEventListener('click', (ev) => {
          ev.stopPropagation();
          buildFilterMenu(th, table, idx);
        });
      }
    });
  })();
</script>
{% endblock %}
